'use strict';

const excelToJson = require('../');
const assert = require('assert');
const child_process = require('child_process');
const path = require('path');
const os = require('os');

// This Excel contains dummy data and it was generated by https://www.mockaroo.com
const sourceFile = `${__dirname}/test-data.xlsx`.replace(/\\/g, '/');

describe('Conversion', function() {

	describe('Simple :: having an Object Literal as a param', function() {
		simple({
			sourceFile: sourceFile
		});
	});

	describe('Simple :: having a JSON String as a param', function() {
		simple(`{
			"sourceFile": "${sourceFile}"
		}`);
	});

	describe('"sheets" config', function() {

		describe('get "sheet1" and "sheet2" configuring "sheets" with an array of string and object', function() {

			const jsonResult = excelToJson({
				sourceFile: sourceFile,
				sheets: ['sheet1', {
					name: 'sheet2'
				}]
			});

			it('should be an Object', function() {
				assert.equal(jsonResult.constructor, Object);
			});

			it('should have two result sets (Object with two keys)', function() {
				assert.equal(Object.keys(jsonResult).length, 2);
			});

			describe('sheet1', function() {

				it('should have a key named "sheet1"', function() {
					assert.notEqual(jsonResult.sheet1, undefined);
				});

				describe('result data', function() {

					it('should have 25 "rows"', function() {
						assert.equal(jsonResult.sheet1.length, 25);
					});

					it('should have the following keys "A", "B", "C", "D", "E", "F"', function() {
						assert.deepEqual(['A', 'B', 'C', 'D', 'E', 'F'], Object.keys(jsonResult.sheet1[0]));
					});

					it('should have the header values (first row) on the first "row"', function() {
						assert.deepEqual({
							A: 'id',
							B: 'first_name',
							C: 'last_name',
							D: 'email',
							E: 'gender',
							F: 'ip_address'
						}, jsonResult.sheet1[0]);
					});

					it('should have the header values on the first position', function() {
						assert.deepEqual({
							A: 'id',
							B: 'first_name',
							C: 'last_name',
							D: 'email',
							E: 'gender',
							F: 'ip_address'
						}, jsonResult.sheet1[0]);
					});

					it('should have the last row data on the last position', function() {
						assert.deepEqual({
							A: '24',
							B: 'Debra',
							C: 'Oliver',
							D: 'dolivern@yolasite.com',
							E: 'Female',
							F: '187.87.117.203'
						}, jsonResult.sheet1[jsonResult.sheet1.length - 1]);
					});
				});
			});

			describe('sheet2', function() {

				it('should have a key named "sheet2"', function() {
					assert.notEqual(jsonResult.sheet2, undefined);
				});

				describe('result data', function() {
					it('should have 27 "rows"', function() {
						assert.equal(jsonResult.sheet2.length, 27);
					});

					it('should have the following keys "A", "B", "C", "D", "E", "F"', function() {
						assert.deepEqual(['A', 'B', 'C', 'D', 'E', 'F'], Object.keys(jsonResult.sheet2[0]));
					});

					it('should have the header values (forst row) on the first position', function() {
						assert.deepEqual({
							A: 'id',
							B: 'first_name',
							C: 'last_name',
							D: 'email',
							E: 'gender',
							F: 'ip_address'
						}, jsonResult.sheet2[0]);
					});

					it('should have the last row data on the last position', function() {
						assert.deepEqual({
							A: '50',
							B: 'Susan',
							C: 'Miller',
							D: 'smiller1d@china.com.cn',
							E: 'Female',
							F: '244.232.244.90'
						}, jsonResult.sheet2[jsonResult.sheet2.length - 1]);
					});
				});
			});
		});

		describe('get only "sheet2" configuring with an array of strings', function() {

			const jsonResult = excelToJson({
				sourceFile: sourceFile,
				sheets: ['sheet2']
			});

			it('should be an Object', function() {
				assert.equal(jsonResult.constructor, Object);
			});

			it('should have one result set (Object with one key)', function() {
				assert.equal(Object.keys(jsonResult).length, 1);
			});

			describe('sheet1', function() {
				it('should not have a key named "sheet1"', function() {
					assert.equal(jsonResult.sheet1, undefined);
				});
			});

			describe('sheet2', function() {

				it('should have a key named "sheet2"', function() {
					assert.notEqual(jsonResult.sheet2, undefined);
				});

				describe('result data', function() {

					it('should have 27 "rows"', function() {
						assert.equal(jsonResult.sheet2.length, 27);
					});

					it('should have the following keys "A", "B", "C", "D", "E", "F"', function() {
						assert.deepEqual(['A', 'B', 'C', 'D', 'E', 'F'], Object.keys(jsonResult.sheet2[0]));
					});

					it('should have the header values on the first "row"', function() {
						assert.deepEqual({
							A: 'id',
							B: 'first_name',
							C: 'last_name',
							D: 'email',
							E: 'gender',
							F: 'ip_address'
						}, jsonResult.sheet2[0]);
					});

					it('should have the header values on the first position', function() {
						assert.deepEqual({
							A: 'id',
							B: 'first_name',
							C: 'last_name',
							D: 'email',
							E: 'gender',
							F: 'ip_address'
						}, jsonResult.sheet2[0]);
					});

					it('should have the last row data on the last position', function() {
						assert.deepEqual({
							A: 50,
							B: 'Susan',
							C: 'Miller',
							D: 'smiller1d@china.com.cn',
							E: 'Female',
							F: '244.232.244.90'
						}, jsonResult.sheet2[jsonResult.sheet2.length - 1]);
					});
				});
			});
		});

		describe('get only "sheet2" configuring with "header.rows"', function() {
			const jsonResult = excelToJson({
				sourceFile: sourceFile,
				sheets: [{
					name: 'sheet2',
					header: {
						rows: 1
					}
				}]
			});

			it('should not have the header values on the first position', function() {
				assert.notDeepEqual({
					A: 'id',
					B: 'first_name',
					C: 'last_name',
					D: 'email',
					E: 'gender',
					F: 'ip_address'
				}, jsonResult.sheet2[0]);
			});
		});

		describe('get only "sheet2" configuring with "columToKey" and "header.rows" within "sheets"', function() {

			const jsonResult = excelToJson({
				sourceFile: sourceFile,
				sheets: [{
					name: 'sheet2',
					header: {
						rows: 1
					},
					columnToKey: {
						A: 'id',
						B: 'firstName',
						D: 'email'
					}
				}]
			});

			it('should be an Object', function() {
				assert.equal(jsonResult.constructor, Object);
			});

			it('should have one result set (Object with one key)', function() {
				assert.equal(Object.keys(jsonResult).length, 1);
			});

			describe('sheet1', function() {
				it('should not have a key named "sheet1"', function() {
					assert.equal(jsonResult.sheet1, undefined);
				});
			});

			describe('sheet2', function() {

				it('should have a key named "sheet2"', function() {
					assert.notEqual(jsonResult.sheet2, undefined);
				});

				describe('result data', function() {

					it('should have 26 "rows"', function() {
						assert.equal(jsonResult.sheet2.length, 26);
					});

					it('should have the following keys "id", "firstName", "email"', function() {
						assert.deepEqual(['id', 'firstName', 'email'], Object.keys(jsonResult.sheet2[0]));
					});

					it('should have the keys found on the header (first row)', function() {
						assert.notDeepEqual({
							id: 'id',
							firstName: 'first_name',
							email: 'email'
						}, jsonResult.sheet2[0]);
					});

					it('should have the first row on the first position', function() {
						assert.deepEqual({
							id: '25',
							firstName: 'Jack',
							email: 'jbishopo@businessinsider.com'
						}, jsonResult.sheet2[0]);
					});

					it('should have the last row data on the last position', function() {
						assert.deepEqual({
							id: '50',
							firstName: 'Susan',
							email: 'smiller1d@china.com.cn'
						}, jsonResult.sheet2[jsonResult.sheet2.length - 1]);
					});
				});
			});
		});

		describe('get only "sheet2" configuring with "columToKey" using cell variables (e.g. {{A1}})', function() {

			const jsonResult = excelToJson({
				sourceFile: sourceFile,
				sheets: [{
					name: 'sheet2',
				}],
				header: {
					rows: 1
				},
				columnToKey: {
					A: '{{A1}}',
					B: '{{B1}}',
					D: '{{D1}}'
				}
			});

			it('should be an Object', function() {
				assert.equal(jsonResult.constructor, Object);
			});

			it('should have one result set (Object with one key)', function() {
				assert.equal(Object.keys(jsonResult).length, 1);
			});

			describe('sheet1', function() {
				it('should not have a key named "sheet1"', function() {
					assert.equal(jsonResult.sheet1, undefined);
				});
			});

			describe('sheet2', function() {

				it('should have a key named "sheet2"', function() {
					assert.notEqual(jsonResult.sheet2, undefined);
				});

				describe('result data', function() {

					it('should have 26 "rows"', function() {
						assert.equal(jsonResult.sheet2.length, 26);
					});

					it('should have the keys found on the header (first row)', function() {
						assert.deepEqual(['id', 'first_name', 'email'], Object.keys(jsonResult.sheet2[0]));
					});

					it('should not have the header values on the first position', function() {
						assert.notDeepEqual({
							id: 'id',
							first_name: 'first_name',
							email: 'email'
						}, jsonResult.sheet2[0]);
					});

					it('should have the first row on the first position', function() {
						assert.deepEqual({
							id: '25',
							first_name: 'Jack',
							email: 'jbishopo@businessinsider.com'
						}, jsonResult.sheet2[0]);
					});

					it('should have the last row data on the last position', function() {
						assert.deepEqual({
							id: '50',
							first_name: 'Susan',
							email: 'smiller1d@china.com.cn'
						}, jsonResult.sheet2[jsonResult.sheet2.length - 1]);
					});
				});
			});
		});

		describe('get only "sheet2" configuring with "columToKey" and "header.rows" out of "sheets", within root config object', function() {

			const jsonResult = excelToJson({
				sourceFile: sourceFile,
				sheets: [{
					name: 'sheet2',
				}],
				header: {
					rows: 1
				},
				columnToKey: {
					A: 'id',
					B: 'firstName',
					D: 'email'
				}
			});

			it('should be an Object', function() {
				assert.equal(jsonResult.constructor, Object);
			});

			it('should have one result set (Object with one key)', function() {
				assert.equal(Object.keys(jsonResult).length, 1);
			});

			describe('sheet1', function() {
				it('should not have a key named "sheet1"', function() {
					assert.equal(jsonResult.sheet1, undefined);
				});
			});

			describe('sheet2', function() {

				it('should have a key named "sheet2"', function() {
					assert.notEqual(jsonResult.sheet2, undefined);
				});

				describe('result data', function() {

					it('should have 26 "rows"', function() {
						assert.equal(jsonResult.sheet2.length, 26);
					});

					it('should have the keys found on the header (first row)', function() {
						assert.deepEqual(['id', 'firstName', 'email'], Object.keys(jsonResult.sheet2[0]));
					});

					it('should not have the header values (first row) on the first position', function() {
						assert.notDeepEqual({
							id: 'id',
							firstName: 'first_name',
							email: 'email'
						}, jsonResult.sheet2[0]);
					});

					it('should have the first row on the first position', function() {
						assert.deepEqual({
							id: '25',
							firstName: 'Jack',
							email: 'jbishopo@businessinsider.com'
						}, jsonResult.sheet2[0]);
					});

					it('should have the last row data on the last position', function() {
						assert.deepEqual({
							id: '50',
							firstName: 'Susan',
							email: 'smiller1d@china.com.cn'
						}, jsonResult.sheet2[jsonResult.sheet2.length - 1]);
					});
				});
			});
		});

		describe('get only "sheet2" configuring with "columToKey" using the special key "*" (all columns) and the special cell variable {{columnHeader}} (the value present on the current columnHeader)', function() {

			const jsonResult = excelToJson({
				sourceFile: sourceFile,
				sheets: [{
					name: 'sheet2',
				}],
				header: {
					rows: 1
				},
				columnToKey: {
					'*': '{{columnHeader}}'
				}
			});

			it('should be an Object', function() {
				assert.equal(jsonResult.constructor, Object);
			});

			it('should have one result set (Object with one key)', function() {
				assert.equal(Object.keys(jsonResult).length, 1);
			});

			describe('sheet1', function() {
				it('should not have a key named "sheet1"', function() {
					assert.equal(jsonResult.sheet1, undefined);
				});
			});

			describe('sheet2', function() {

				it('should have a key named "sheet2"', function() {
					assert.notEqual(jsonResult.sheet2, undefined);
				});

				describe('result data', function() {

					it('should have 26 "rows"', function() {
						assert.equal(jsonResult.sheet2.length, 26);
					});

					it('should have the keys found on the header (first row)', function() {
						assert.deepEqual(['id', 'first_name', 'last_name', 'email', 'gender', 'ip_address'], Object.keys(jsonResult.sheet2[0]));
					});
				});
			});
		});
	});
});

describe('Execution via CLI', function() {
	const cliPath = path.resolve(`${__dirname}/../bin/cli.js`);
	const sourceFileTest = path.resolve(`${__dirname}/../tests/test-data-2.xlsx`);
	const expectedResult = `{"sheet1":[{"A":"date","B":"number"},{"A":"2017-10-10T03:00:00.000Z","B":1},{"A":"2017-10-11T03:00:00.000Z","B":2},{"A":"2017-10-12T03:00:00.000Z","B":3},{"A":"2017-10-13T03:00:00.000Z","B":4},{"A":"2017-10-14T03:00:00.000Z","B":5},{"A":"2017-10-15T03:00:00.000Z","B":6},{"A":"2017-10-16T03:00:00.000Z","B":7},{"A":"2017-10-17T03:00:00.000Z","B":8},{"A":"2017-10-18T03:00:00.000Z","B":9},{"A":"2017-10-19T03:00:00.000Z","B":10}]}`

	it('should work when passing in a JSON to --config', function(done) {
		child_process.exec(`${cliPath}  --config='{"sourceFile": "${sourceFileTest}"}' `, (err, stdout, stderr) => {
			const result = stdout.replace(RegExp(os.EOL, 'g'), '');
			assert.equal(result, expectedResult);
			done();
		});
	});

	it('should work when passing a file path to --sourceFile', function(done) {
		child_process.exec(`${cliPath}  --sourceFile=${sourceFileTest}`, (err, stdout, stderr) => {
			const result = stdout.replace(RegExp(os.EOL, 'g'), '');
			assert.equal(result, expectedResult);
			done();
		});
	});
});

function simple(config) {

	const jsonResult = excelToJson(config);

	it('should be an Object', function() {
		assert.equal(jsonResult.constructor, Object);
	});

	it('should have two result sets (Object with two keys)', function() {
		assert.equal(Object.keys(jsonResult).length, 2);
	});

	describe('sheet1', function() {

		it('should have a key named "sheet1"', function() {
			assert.notEqual(jsonResult.sheet1, undefined);
		});

		describe('result data', function() {

			it('should have 25 "rows"', function() {
				assert.equal(jsonResult.sheet1.length, 25);
			});

			it('should have the following keys "A", "B", "C", "D", "E", "F"', function() {
				assert.deepEqual(['A', 'B', 'C', 'D', 'E', 'F'], Object.keys(jsonResult.sheet1[0]));
			});

			it('should have the header values on the first position', function() {
				assert.deepEqual({
					A: 'id',
					B: 'first_name',
					C: 'last_name',
					D: 'email',
					E: 'gender',
					F: 'ip_address'
				}, jsonResult.sheet1[0]);
			});

			it('should have the last row data on the last position', function() {
				assert.deepStrictEqual({
					A: 24,
					B: 'Debra',
					C: 'Oliver',
					D: 'dolivern@yolasite.com',
					E: 'Female',
					F: '187.87.117.203'
				}, jsonResult.sheet1[jsonResult.sheet1.length - 1]);
			});
		});
	});

	describe('sheet2', function() {

		it('should have a key named "sheet2"', function() {
			assert.notEqual(jsonResult.sheet2, undefined);
		});

		describe('result data', function() {
			it('should have 27 "rows"', function() {
				assert.equal(jsonResult.sheet2.length, 27);
			});

			it('should have the following keys "A", "B", "C", "D", "E", "F"', function() {
				assert.deepEqual(['A', 'B', 'C', 'D', 'E', 'F'], Object.keys(jsonResult.sheet2[0]));
			});

			it('should have the header values on the first position', function() {
				assert.deepEqual({
					A: 'id',
					B: 'first_name',
					C: 'last_name',
					D: 'email',
					E: 'gender',
					F: 'ip_address'
				}, jsonResult.sheet2[0]);
			});

			it('should have the last row data on the last position', function() {
				assert.deepStrictEqual({
					A: 50,
					B: 'Susan',
					C: 'Miller',
					D: 'smiller1d@china.com.cn',
					E: 'Female',
					F: '244.232.244.90'
				}, jsonResult.sheet2[jsonResult.sheet2.length - 1]);
			});
		});
	});
}